---
- name: ensure plugin directory exists
  file:
    path: "{{ fitnesse_path }}/plugins"
    state: directory
    owner: "{{ fitnesse_username }}"
    group: "{{ fitnesse_group }}"
  tags:
    - fitnesse
    - plugins

- name: ensure plugins.properties configurations are added
  lineinfile:
    dest: "{{ fitnesse_path }}/plugins.properties"
    line: "{{ item.configuration }}"
    owner: "{{ fitnesse_username }}"
    group: "{{ fitnesse_group }}"
    create: yes
  when: item.configuration is defined
  with_items: fitnesse_plugins
  tags:
    - fitnesse
    - plugins

# - name: ensure fitnesse jar is installed for maven builds
  # shell: "mvn install:install-file -Dfile={{ fitnesse_path }}/fitnesse-standalone.jar -DgroupId=org.fitnesse -DartifactId=fitnesse -Dversion=20150927-SNAPSHOT -Dpackaging=jar"
  # tags:
    # - fitnesse
    # - plugins
#
# - name: ensure plugin source repos exist
  # git:
    # repo: "{{ item.repo.url }}"
    # dest: "/tmp/fitnesse/{{ (item.repo.url.split('/')|last)[:-4] }}/"
  # when: item.repo is defined and item.repo.type == 'git'
  # with_items: fitnesse_plugins
  # tags:
    # - fitnesse
    # - plugins
#
# - name: ensure ossrhUsername is declared
  # lineinfile:
    # dest: ~/.gradle/gradle.properties
    # line: "ossrhUsername="
    # create: yes
  # tags:
    # - fitnesse
    # - plugins
#
# - name: ensure sonatypePassword is declared
  # lineinfile:
    # dest: ~/.gradle/gradle.properties
    # line: "ossrhPassword="
  # tags:
    # - fitnesse
    # - plugins
#
# - name: ensure maven plugin jars are built
  # shell: mvn package
  # args:
    # chdir: "/tmp/fitnesse/{{ (item.repo.url.split('/')|last)[:-4] }}/"
  # when: item.build is defined and item.build.type == 'maven'
  # with_items: fitnesse_plugins
  # tags:
    # - fitnesse
    # - plugins
#
# - name: ensure gradles plugin jars are built
  # shell: ./gradlew build
  # args:
    # chdir: "/tmp/fitnesse/{{ (item.repo.url.split('/')|last)[:-4] }}/"
  # when: item.build is defined and item.build.type == 'gradles'
  # with_items: fitnesse_plugins
  # tags:
    # - fitnesse
    # - plugins

- name: ensure plugins are installed
  get_url:
    url: "{{ item.url }}"
    dest: "{{ fitnesse_path }}/plugins/"
    owner: "{{ fitnesse_username }}"
    group: "{{ fitnesse_group }}"
  when: item.url is defined
  with_items: fitnesse_plugins
  tags:
    - fitnesse
    - plugins
